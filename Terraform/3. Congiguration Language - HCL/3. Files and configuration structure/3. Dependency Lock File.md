# Dependency Lock File

-> **Note:** Trang này nói về tính năng có trong Terraform 0.14 trở lên.

> **Hands-on:** Hãy thử tutorial [Lock and Upgrade Provider Versions](/terraform/tutorials/configuration-language/provider-versioning?utm_source=WEBSITE&utm_medium=WEB_IO&utm_offer=ARTICLE_PAGE&utm_content=DOCS).

Một Terraform configuration có thể tham chiếu đến hai loại dependency bên ngoài:

- [Providers](/terraform/language/providers/requirements): plugin mở rộng Terraform để tương tác với các hệ thống bên ngoài.
- [Modules](/terraform/language/modules): cho phép chia nhỏ cấu hình Terraform thành các khối tái sử dụng.

Cả hai loại dependency này có thể được publish và update độc lập với Terraform và các configuration phụ thuộc vào chúng.
Vì vậy, Terraform cần xác định phiên bản nào của các dependency đó tương thích với configuration hiện tại và phiên bản nào được chọn để sử dụng.

[Version constraints](/terraform/language/expressions/version-constraints) trong configuration sẽ quyết định các phiên bản **có thể** tương thích.
Sau khi chọn được phiên bản cụ thể, Terraform sẽ lưu lại quyết định đó trong dependency lock file để đảm bảo các lần chạy sau vẫn chọn giống vậy.

Hiện tại, lock file chỉ track dependency loại `provider`.Terraform không lưu thông tin phiên bản của remote module, nên mặc định Terraform sẽ luôn chọn phiên bản module mới nhất thỏa mãn constraint.
Nếu muốn Terraform luôn dùng một phiên bản module cố định, bạn có thể đặt constraint chính xác (`exact version constraint`).

## Lock File Location

Lock file là file thuộc về toàn bộ configuration (root module), chứ không phải từng module riêng lẻ.
Vì vậy, Terraform tạo và tìm nó trong **current working directory**, nơi chứa các file `.tf` của root module.

Tên file luôn là `.terraform.lock.hcl`, cho biết nó là file khóa cho các item Terraform cache trong thư mục con `.terraform`.

Terraform tự động tạo hoặc update lock file mỗi khi bạn chạy `terraform init`.
Bạn nên commit file này vào version control (Git, v.v.) để team có thể review thay đổi dependency tương tự như review code.

Lock file dùng cùng cú pháp HCL như Terraform, nhưng bản thân nó **không** phải là file cấu hình Terraform.
Phần mở rộng `.hcl` thay vì `.tf` giúp phân biệt điều này.

## Dependency Installation Behavior

Khi `terraform init` chạy, Terraform sẽ xem xét cả version constraints trong cấu hình **và** version đã lưu trong lock file.

- Nếu provider chưa có trong lock file → Terraform chọn phiên bản mới nhất thỏa constraint rồi thêm vào file.
- Nếu provider đã có → Terraform cài đúng phiên bản đã lưu, kể cả khi có bản mới hơn.
  Dùng tùy chọn `-upgrade` để buộc Terraform chọn lại bản mới nhất.

Nếu `terraform init` thay đổi lock file, Terraform sẽ log thông báo như sau:

```
Terraform has made some changes to the provider dependency selections recorded
in the .terraform.lock.hcl file. Review those changes and commit them to your
version control system if they represent changes you intended to make.
```

Khi thấy thông báo này, hãy review diff trong VCS để xác nhận thay đổi có đúng ý định không trước khi merge.

### Checksum verification

Terraform sẽ verify mỗi package được cài bằng checksum đã ghi trong lock file.
Nếu checksum không khớp, Terraform sẽ báo lỗi:

```
Error: Failed to install provider

Error while installing hashicorp/azurerm v2.1.0: the current package for
registry.terraform.io/hashicorp/azurerm 2.1.0 doesn't match any of the
checksums previously recorded in the dependency lock file.
```

Cơ chế này dựa trên mô hình _trust on first use_ — bạn xác minh provider lần đầu theo quy trình riêng, sau đó Terraform đảm bảo mọi lần sau không có thay đổi bất thường.

Trường hợp đặc biệt:

- Nếu registry có cung cấp checksum kèm chữ ký số, Terraform sẽ chấp nhận bất kỳ checksum nào được ký hợp lệ. Khi đó Terraform hiển thị fingerprint của key ký checksum, ví dụ `(signed by a HashiCorp partner, key ID DC9FC6B1FCE47986)`.
- Nếu cài provider từ mirror (filesystem/network), Terraform chỉ có thể ghi checksum cho platform hiện tại. Để tránh lỗi khi chạy trên platform khác, hãy dùng [`terraform providers lock`](/terraform/cli/commands/providers/lock) để pre-populate checksum cho nhiều platform.

## Understanding Lock File Changes

Lock file chủ yếu được Terraform tự động duy trì. Khi thấy diff trong VCS, bạn nên hiểu loại thay đổi nào Terraform thực hiện.

Một số thay đổi phổ biến gồm:

### Dependency on a new provider

Nếu bạn thêm provider mới hoặc module có provider mới, `terraform init` sẽ thêm block `provider` mới vào lock file, ví dụ:

```diff
+provider "registry.terraform.io/hashicorp/azurerm" {
+  version     = "2.30.0"
+  constraints = "~> 2.12"
+  hashes = [ ... ]
+}
```

### New version of an existing provider

Khi chạy `terraform init -upgrade`, Terraform có thể chọn phiên bản mới hơn phù hợp constraint và cập nhật `provider` block tương ứng.

### New provider package checksums

Khi Terraform gặp provider được cài trên platform khác, nó có thể thêm checksum mới (`h1:` hoặc `zh:`) vào `hashes` để hỗ trợ nhiều scheme hash hơn.

Dùng `terraform providers lock -platform=linux_amd64 -platform=windows_amd64 ...` để pre-generate hash cho các platform.

### Providers that are no longer required

Nếu provider không còn trong cả configuration và state, Terraform sẽ xóa block tương ứng khỏi lock file.

-> **Note:** Trong Terraform ≤ v1.0, `terraform init` không tự xóa provider cũ trong lock file. Nếu gặp lỗi “missing or corrupted provider plugins”, hãy chạy lại `terraform init` với Terraform ≥ v1.1 để dọn dẹp file.
