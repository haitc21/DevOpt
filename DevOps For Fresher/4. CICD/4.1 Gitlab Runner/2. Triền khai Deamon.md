
3. Viết kịch bản

- tạo file .gitlab-ci.yml trong thư mục gốc của dự án

``` yml
stages:
  - build
  - deploy
  - checklog

build:
  stage: build
  script:
    - whoami
    - pwd
    - ls
  tags:
    - gitlab-server

```

- Build => Pipeline
![](./image/8.png)

- Chi tiết job
![](./image/9.png)

>NOTE: Khi chỉnh sửa bất cứ file nào thì pipeline sẽ được chạy. Sẽ xóa toàn bộ code cũ đi và downloa code mới.Qua mỗi stage cũng xóa đi down lại


-Thêm stage deploy

``` yml
variables:
  projectuser: java1
  projectname: demo
  projectversion: 0.0.1-SNAPSHOT
  projectpath: /projects/$projectuser/

stages:
  - build
  - deploy
  - checklog

build:
  stage: build
  variables:
    GIT_STRATEGY: clone
  script:
    - cd src/demo/
    - mvn clean install -DskipTests=true
  tags:
    - gitlab-server

deploy:
  stage: deploy
  variables:
    GIT_STRATEGY: none
  script:
    - sudo cp src/demo/target/$projectname-$projectversion.jar $projectpath
    - sudo chown -R $projectuser. $projectpath
    - sudo su $projectuser -c "ps -ef | grep $projectname-$projectversion.jar | grep -v grep | awk '{print \$2}' | xargs -r kill -9"
    - sudo su $projectuser -c "cd $projectpath; nohup java -jar $projectname-$projectversion.jar > nohup.out 2>&1 &"
  tags:
    - gitlab-server

```

>NOTE: câu lệnh kill chỉ chạy từ lần 2 trở đi vì khi đó có process cũ đang chạy cần kill đi

- thêm only tags để chỉ chạy khi có tag mới

``` yml
variables:
  projectuser: java1
  projectname: demo
  projectversion: 0.0.1-SNAPSHOT
  projectpath: /projects/$projectuser/

stages:
  - build
  - deploy
  - checklog

build:
  stage: build
  variables:
    GIT_STRATEGY: clone
  script:
    - cd src/demo/
    - mvn clean install -DskipTests=true
  tags:
    - gitlab-server
  only:
  - tags

deploy:
  stage: deploy
  variables:
    GIT_STRATEGY: none
  script:
    - sudo cp src/demo/target/$projectname-$projectversion.jar $projectpath
    - sudo chown -R $projectuser. $projectpath
    - sudo su $projectuser -c "ps -ef | grep $projectname-$projectversion.jar | grep -v grep | awk '{print \$2}' | xargs -r kill -9"
    - sudo su $projectuser -c "cd $projectpath; nohup java -jar $projectname-$projectversion.jar > nohup.out 2>&1 &"
  tags:
    - gitlab-server
  only:
  - tags
```

- Thêm stage sholog

```yml
# Khai báo biến global
variables:
  projectuser: java1
  projectname: demo
  projectversion: 0.0.1-SNAPSHOT
  projectpath: /projects/$projectuser/

# Khai báo tên các bước
stages:
  - build
  - deploy
  - checklog

# Bước 1 build dữ ạ
build:
#tên stage trùng với ở trên
  stage: build
  #biến nội bộ trong stage build
  variables:
  #Xóa code cũ clone code mới
    GIT_STRATEGY: clone
  script:
    - cd src/demo/
    #build dự án java
    - mvn clean install -DskipTests=true
  tags:
  #Chỉ định runner có tag là gitlab-runner
    - gitlab-server
  only:
  #Chỉ khi repo có tag mới thì mới run ci. Ví dụ tag v1.0
  - tags
#Deploy dự án
deploy:
  stage: deploy
  variables:
  #Không cần clone code
    GIT_STRATEGY: none
  script:
  #copy file jar sang thư mục deploy
    - sudo cp src/demo/target/$projectname-$projectversion.jar $projectpath
    #Chỉnh sửa quyền
    - sudo chown -R $projectuser. $projectpath
    #Khi deployu lần 2 trở đi thì cần kill process cũ
    #grep -v grep: Vì khi search sẽ ra 2 kết quả mà kết quả thứ 2 chính là process tìm kiếm nên cần bỏ kết quả đó
    #awk '{print $2}')": lấy kết quả ở cột 2 chính là PID
    - sudo su $projectuser -c "ps -ef | grep $projectname-$projectversion.jar | grep -v grep | awk '{print \$2}' | xargs -r kill -9"
    #Chạy dự án lưu log vào file nohp.out
    - sudo su $projectuser -c "cd $projectpath; nohup java -jar $projectname-$projectversion.jar > nohup.out 2>&1 &"
  tags:
    - gitlab-server
  only:
  - tags

checklog:
  stage: checklog
  variables:
    GIT_STRATEGY: none
  script:
  #Xem log trong file nohup.out
    - sudo su $projectuser -c "cd $projectpath; tail -n 10000 nohup.out"
  tags:
    - gitlab-server
  only:
  - tags

```

- cấu hình thêm [Continuous Deliver](https://www.youtube.com/watch?v=y-ByTDU_Lg8&list=PLsvroIvFNP1KU8foUeCC-hbJbqnAggWL2&index=18)
  - when: manual: Chạy stage thủ công
  - if [ "$GITLAB_USER_LOGIN" == 'lead1' ]; Chỉ user lead1 mới có thể chạy stage deploy

``` yml
# Khai báo biến global
variables:
  projectuser: java1
  projectname: demo
  projectversion: 0.0.1-SNAPSHOT
  projectpath: /projects/$projectuser/

# Khai báo tên các bước
stages:
  - build
  - deploy
  - checklog

# Bước 1 build dữ ạ
build:
  #tên stage trùng với ở trên
  stage: build
  #biến nội bộ trong stage build
  variables:
    #Xóa code cũ clone code mới
    GIT_STRATEGY: clone
  script:
    - cd src/demo/
    #build dự án java
    - mvn clean install -DskipTests=true
  tags:
    #Chỉ định runner có tag là gitlab-runner
    - gitlab-server
  only:
    #Chỉ khi repo có tag mới thì mới run ci. Ví dụ tag v1.0
    - tags
#Deploy dự án
deploy:
  stage: deploy
  variables:
    #Không cần clone code
    GIT_STRATEGY: none
  when: manual
  script:
    >
      if [ "$GITLAB_USER_LOGIN" == 'lead1' ]; then
        sudo cp src/demo/target/$projectname-$projectversion.jar $projectpath
        sudo chown -R $projectuser. $projectpath
        sudo su $projectuser -c "ps -ef | grep $projectname-$projectversion.jar | grep -v grep | awk '{print \$2}' | xargs -r kill -9"
        sudo su $projectuser -c "cd $projectpath; nohup java -jar $projectname-$projectversion.jar > nohup.out 2>&1 &"
      else
        echo "Permission denined!"
        exit 1
      fi
  tags:
    - gitlab-server
  only:
    - tags

checklog:
  stage: checklog
  variables:
    GIT_STRATEGY: none
  when: manual
  script:
    #Xem log trong file nohup.out
    - sudo su $projectuser -c "cd $projectpath; tail -n 10000 nohup.out"
  tags:
    - gitlab-server
  only:
    - tags

```
